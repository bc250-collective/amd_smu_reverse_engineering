import os

#SMU_ARG_ADDR = 0x03B10292
#SMU_CMD_ADDR = 0x03B10282
#SMU_RSP_ADDR = 0x03B1092a

#SMU_CMD_ADDR = 0x03B10528
#SMU_RSP_ADDR = 0x03B10564
#SMU_ARG_ADDR = 0x03B10998

SMU_CMD_ADDR = 0x03B10A20
SMU_RSP_ADDR = 0x03B10A80
SMU_ARG_ADDR = 0x03B10A88

def writesmureg(reg, value=0):
    os.popen('setpci -v -s 0:0.0 b8.l={:08X}'.format(reg)).read()
    os.popen('setpci -v -s 0:0.0 bc.l={:08X}'.format(value)).read()


def readsmureg(reg):
    os.popen('setpci -v -s 0:0.0 b8.l={:08X}'.format(reg)).read()
    output = os.popen('setpci -v -s 0:0.0 bc.l').read()
    return int(output[-9:][0:8], 16)


def writesmu(cmd, value=0):
    res = False
    # clear the response register
    writesmureg(SMU_RSP_ADDR, 0)
    # write the value
    writesmureg(SMU_ARG_ADDR, value)
    writesmureg(SMU_ARG_ADDR + 4, 0)
    # send the command
    writesmureg(SMU_CMD_ADDR, cmd)
    res = smuwaitdone()
    if res:
        return readsmureg(SMU_RSP_ADDR)
    else:
        return readsmureg(SMU_RSP_ADDR)

def smuwaitdone():
    res = False
    timeout = 1000
    data = 0
    while ((not res or data != 1) and timeout > 0):
        timeout-=1
        data = readsmureg(SMU_RSP_ADDR)
        if data == 1:
            res = True
        if (timeout == 0 or data != 1):
            res = False
    return res
